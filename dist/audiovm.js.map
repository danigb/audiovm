{"version":3,"file":"audiovm.js","sources":["../src/index.js"],"sourcesContent":["let nextId = 1;\n\n/**\n * Create a process\n * @return {Process} \n */\nexport function process(props) {\n  const proc = {\n    id: nextId++,\n    time: 0,\n    context: {},\n    stack: [],\n    operations: []\n  };\n  Object.assign(proc, props);\n\n  proc.exec = (lib = {}, maxTime = Infinity, maxOps = 1000) => {\n    while (proc.time < maxTime && --maxOps && proc.operations.length) {\n      const op = proc.operations.pop();\n      if (typeof op === \"function\") op(proc, lib);\n      else if (typeof op === 'string' && op[0] === '@') proc.call(lib, op);\n      else proc.stack.push(op);\n    }\n    return proc;\n  };\n\n  proc.load = program => {\n    let i = program.length;\n    while (i--) {\n      proc.operations.push(program[i]);\n    }\n    return proc;\n  };\n\n  proc.call = (lib, name) => {\n    const fn = lib[name];\n    if (typeof fn === \"function\") {\n      fn(proc, lib);\n    } else {\n      console.warn(name + \" is not a function.\");\n    }\n  };\n\n  return proc;\n}\n\n\n/**\n * A reference clock. A clock is a function that accepts a callback\n * and call the callback at a given interval\n * \n * @param {Number} interval - the interval of the clock in seconds\n * @return {Function} \n */\nexport const clock = (interval = 0.1) =>\n  resume => {\n    const id = setInterval(() => resume(interval), interval * 1000);\n    return () => clearInterval(id);\n  };\n\n/**\n * Create a scheduler\n * \n * @param {Object} library - the library\n * @param {Function} clock \n */\nexport function scheduler(baseLib = {}, start = clock()) {\n  let time = 0;\n  const queue = [];\n\n  // add scheduling functions to library\n  const lib = Object.assign(baseLib, {});\n\n  // insert a process in a priority queue\n  function schedule(proc) {\n    let i = queue.length - 1;\n    while (i >= 0 && queue[i].time < proc.time) {\n      i--;\n    }\n    queue.splice(i + 1, 0, proc);\n    return proc;\n  }\n\n  // resume process for a duration (expressed in seconds)\n  start((duration, limit = 1000) => {\n    const endsAt = time + duration;\n    let proc = queue.pop();\n    while (proc && proc.time < endsAt && limit--) {\n      proc.exec(lib, endsAt);\n      if (proc.operations.length) schedule(proc);\n      proc = queue.pop();\n    }\n    if (proc) queue.push(proc);\n    time = endsAt;\n  });\n\n  // API: return a function to run programs\n  function run(program, delay) {\n    return schedule(process({ time }).load(program));\n  }\n  run.lib = lib;\n  return run;\n}\n\nconst OPERATOR = /^(@[^-]+)(-.*)$/;\nexport function compiler() {\n  return function compile(program) {\n    let m;\n    return program.reduce(\n      (compiled, op) => {\n        if (Array.isArray(op)) {\n          compiled.push(compile(op));\n        } else if ((m = OPERATOR.exec(op))) {\n          compiled.push(m[2].slice(1));\n          compiled.push(m[1]);\n        } else {\n          compiled.push(op);\n        }\n        return compiled;\n      },\n      []\n    );\n  };\n}\n"],"names":[],"mappings":"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"}