!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(n.AudioVM={})}(this,function(n){"use strict";function t(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r={id:""+a++,parent:n,time:t,context:e,stack:[]},o=[],c=function(n){return function(){return console.warning(n+" is not in library")}},u=function(n,t){return(n.lib[t]||c(t))(r,n)};return r.exec=function(n){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3;r.time<t&&--e&&o.length;){var c=o.pop();"function"==typeof c?c(r,n):"string"==typeof c&&"@"===c[0]?u(n,c):r.stack.push(c)}if(!e)throw Error("[proc:"+r.id+" - Loop limit reached");return o.length},r.stop=function(){return o.length=0},r.load=function(n){for(var t=n.length;t--;)o.push(n[t]);return r},r}function e(){function n(n){for(var t=o.length-1;t>=0&&o[t].time<n.time;)t--;return o.splice(t+1,0,n),c||(c=!0),n}var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:f(),o=[],c=!1;return e.schedule=n,n.time=0,n.env=e,n.fork=function(e,r){return n(t(e,n.time)).load(r)},n.count=function(){return o.length},n.processes=function(){return o.slice()},n.find=function(n){return o.find(function(t){return t.id===n})},n.remove=function(n){for(var t=0;t<o.length;t++)if(o[t].id===n)return o.splice(t,1),!0;return!1},n.removeAll=function(){return o.length=0},r(function(t){for(var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3,c=n.time+t,u=o.pop();u&&u.time<c&&r--;)u.exec(e,c)&&n(u),u=o.pop();u&&o.push(u),n.time=c}),n}function r(n,t){var r=e(n,t);return{env:n,schedule:r,run:function(n){return(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&(r.count()?n.unshift("@sync"):r.time=Math.floor(r.time+1)),r.fork(null,n)}}}function o(n,t){if(1===arguments.length)return function(t){return o(n,t)};for(var e=t<0?-1:1,r=e*t,c=[],u=0;u<r;u++)c.push(n(e*u));return c}function c(n){var t=G.exec(n);if(!t)return NaN;var e=(t[1].toUpperCase().charCodeAt(0)+3)%7,r=t[2].replace(/x/g,"##"),o=+t[3]||-1,c="b"===r[0]?-1:1;return q[e]+c*r.length+12*o+12}function u(n){var t=i(n),e=[],r=function(n){return e[n]||(e[n]=t[n]())};return Object.keys(t).reduce(function(n,t){return n["@"+t]=function(){r(t).note()},n["@"+t+":note"]=function(n){var e=r(t);e[n.stack.pop()]=n.stack.pop(),e.note()},n["@"+t+":set"]=function(n){r(t)[n.stack.pop()]=n.stack.pop()},n},{})}function i(n){return{kick:function(){return new n.Kick({decay:.2,freq:80}).connect()},snare:function(){return new n.Snare({amp:.3,snappy:1.5}).connect()},hat:function(){return new n.Hat({amp:1.5}).connect()},conga:function(){return new n.Conga({amp:.25,freq:400}).connect()},tom:function(){return new n.Tom({amp:.25,freq:400}).connect()},pluck:function(){var t=new n.PolyKarplusStrong({freq:400,maxVoices:32,amp:.7}).connect(),e=t.note.bind(t),r=n.sampleRate;return t.note=function(){var n=t.freq,o=t.amp;t.damping=1- -6/Math.log(n/r),e(n,o)},t},bass:function(){return new n.MonoSynth({attack:44,decay:n.Time.beats(.25),filterMult:.25,octave2:0,octave3:0}).connect()}}}var a=1,f=function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.1;return function(t){var e=setInterval(function(){return t(n)},1e3*n);return function(){return clearInterval(e)}}},s={"@eval":function(n){var t=n.stack.pop();n.load(t)},"@log":function(n){var t=n.stack.pop();console.log(n.time,t)},"@dup":function(n){var t=n.stack[n.stack.length-1];n.stack.push(t)},"@call":function(n){var t=n.stack.pop();n.load(["@"+t])},"@defn":function(n,t){var e="@"+n.stack.pop(),r=n.stack.pop();t.lib[e]=function(n){return n.load(r)}},"@let":function(n){var t=n.stack.pop(),e=n.stack.pop();n.context||(n.context={}),n.context[t]=e},"@get":function(n){for(var t=n.stack.pop(),e=n;void 0===e.context[t]&&e.parent;)e=e.parent;n.stack.push(e.context[t])},"@set":function(n){for(var t=n.stack.pop(),e=n.stack.pop(),r=n;void 0===r.context[t]&&r.parent;)r=r.parent;r.context[t]=e}},p=function(n,t){return(n%t+t)%t},l=function(n){return function(t){t.stack.push(n(t.stack.pop()))}},v=function(n){return function(t){t.stack.push(n(t.stack.pop(),t.stack.pop()))}},h={"@add":v(function(n,t){return t+n}),"@sub":v(function(n,t){return t-n}),"@mul":v(function(n,t){return t*n}),"@div":v(function(n,t){return 0===n?0:t/n}),"@wrap":v(function(n,t){return 0===n?0:p(t,n)}),"@mod":v(function(n,t){return 0===n?0:t%n}),"@neg":l(function(n){return-n}),"@cond":function(n){var t=n.stack.pop(),e=n.stack.pop(),r=n.stack.pop();t?n.load(r):n.load(e)},"@>":v(function(n,t){return t>n}),"@>=":v(function(n,t){return t>=n}),"@<":v(function(n,t){return t<n}),"@<=":v(function(n,t){return t<=n}),"@==":v(function(n,t){return t===n}),"@!=":v(function(n,t){return t!==n}),"@not":l(function(n){return!n}),"@and":v(function(n,t){return t&&n}),"@or":v(function(n,t){return t||n})},d={"@wait":function(n){var t=n.stack.pop();n.time+=t},"@sync":function(n){Math.floor(n.time)+1-n.time<.99&&(n.time=Math.floor(n.time+1))},"@id":function(n){var t=n.stack.pop();n.id=t},"@exit":function(n){n.stop()},"@repeat":function(n){var t=n.stack.pop(),e=n.stack.pop();t>1&&n.load([e,t-1,"@repeat"]),n.load(e)},"@forever":function(n){var t=n.stack.pop();n.load([t,"@forever"]),n.load(t)},"@fork":function(n,t){if(t.schedule){var e=n.stack.pop();t.schedule.fork(n,e)}},"@spawn":function(n,t){if(t.schedule){var e=n.stack.pop();t.schedule.remove(e);var r=n.stack.pop();t.schedule.fork(n,[e,"@id",r,"@forever"])}},"@loop":function(n,t){if(t.schedule){var e=n.stack.pop();t.schedule.fork(n,[e,"@forever"])}},"@stop:all":function(n,t){t.schedule&&t.schedule.removeAll()},"@stop":function(n,t){var e=n.stack.pop(),r=t.schedule.remove(e);console.log("stop",e,r)},"@pause":function(n){},"@resume":function(n){}},k={"@each":function(n){var t=n.stack.pop(),e=n.stack[n.stack.length-1];if(e.length){var r=e.shift();n.load([r,t,"@eval",t,"@each"])}}},m=Math.floor,g=Math.random,b=function(n){return m(g()*n)},y={"@rand":function(n){n.stack.push(g())},"@pick":function(n){var t=n.stack[n.stack.length-1];n.stack.push(t[b(t.length)])}},w=Math.floor,x=function(n,t){return(n%t+t)%t},M=function(n){var t=c(n);return isNaN(t)?parseFloat(n):t},A=("C Db D Eb E F Gb G Ab A Bb B".split(" "),function(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:440;return Math.pow(2,(n-69)/12)*t}),j=function(n){return function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return function(e){var r=x(e,n.length),o=w(e/n.length);return t+n[r]+12*o}}},S={chromatic:function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return function(t){return n+t}},major:j([0,2,4,5,7,9,11]),minor:j([0,2,3,5,7,8,10])},G=/^([a-gA-G])(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*$/,q=[0,2,4,5,7,9,11],E={"@mtof":function(n){var t=M(n.stack.pop());n.stack.push(A(t))},"@scale":function(n){var t=n.stack.pop(),e=M(n.stack.pop()),r=n.stack.pop(),c=S[r]?o(S[r](e),t):[];n.stack.push(c)}},O=Object.assign({},s,h,d,k,y,E),C="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n},N=Array.isArray,$=function(n,t,e,r,o){return N(t)?n.push(o(t)):n.push(t),n},D=function(n){return function(t){return function(e,r,o,c,u){var i=n(r,o,c);if(i)return t(e,r,o,c,u,i),e}}},F=function(n){return D(function(t){return"string"==typeof t&&n.exec(t)})},T=/^[\d\.]+$/,B=function(n,t){return n||(n=function(){return!1}),function e(r){if(!N(r))return e([r])[0];var o=r.slice().reduce(function(t,r,o,c){return n(t,r,o,c,e)||$(t,r,o,c,e)},[]);return t?t(o):o}}(function(n){return function(t,e,r,o,c){for(var u=0;u<n.length;u++){var i=n[u](t,e,r,o,c);if(i)return i}}}([F(/^##/)(function(){return null}),F(/^>>(@.+)$/)(function(n,t,e,r,o,c){if(0!==e)throw Error("Forward operator must be the first of an array");var u=r.slice(1).reverse();u.push(c[1]),o(u).forEach(function(t){return n.push(t)}),r.length=0}),F(/^(@[^-]+)(-.*)$/)(function(n,t,e,r,o,c){var u=c[2].slice(1);n.push(T.test(u)?+u:u),n.push(c[1])})])),I={macros:B,legacy:B},K=Object.freeze({debugLibrary:function(n){var t=Object.keys(n);return t.forEach(function(t){var e=n[t];n[t]=function(n,r){var o=n.stack[n.stack.length-1],c=n.stack[n.stack.length-2];console.log("at",n.time,t,o,c),e(n,r)}}),t}});n.Transpile=I,n.Debug=K,n.initGibberish=function(n){!n&&void 0!==("undefined"==typeof window?"undefined":C(window))&&window.Gibberish&&(n=window.Gibberish),n.context||n.init();return r({Gibberish:n,lib:Object.assign({},O,u(n))},function(t){var e=1/n.context.sampleRate;n.sequencers.push({tick:function(){return t(e)}})})},Object.defineProperty(n,"__esModule",{value:!0})});
