!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(n.AudioVM={})}(this,function(n){"use strict";function t(n){var t={id:i++,time:0,context:{},stack:[],operations:[]};return Object.assign(t,n),t.exec=function(n){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3;t.time<e&&--o&&t.operations.length;){var r=t.operations.pop();"function"==typeof r?r(t,n):"string"==typeof r&&"@"===r[0]?t.call(n,r):t.stack.push(r)}if(!o)throw Error("[proc:"+t.id+" - Loop limit reached");return t},t.load=function(n){for(var e=n.length;e--;)t.operations.push(n[e]);return t},t.call=function(n,e){var o=n.lib[e];"function"==typeof o?o(t,n):console.warn(e+" is not a function.")},t}function e(){function n(n){for(var t=c.length-1;t>=0&&c[t].time<n.time;)t--;return c.splice(t+1,0,n),n}var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:a(),r=0,c=[];return n.env=Object.assign({schedule:n},e),n.fork=function(e,o){return n(t({parent:e,time:r}).load(o))},n.processes=function(){return c.slice()},n.find=function(n){return c.find(function(t){return t.id===n})},n.remove=function(n){for(var t=0;t<c.length;t++)if(c[t].id===n)return c.splice(t,1),!0;return!1},o(function(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3,o=r+t,u=c.pop();u&&u.time<o&&e--;)u.exec(n.env,o),u.operations.length&&n(u),u=c.pop();u&&c.push(u),r=o}),n}function o(){return function n(t){var e=void 0;return t.reduce(function(t,o){return Array.isArray(o)?t.push(n(o)):(e=f.exec(o))?(t.push(e[2].slice(1)),t.push(e[1])):t.push(o),t},[])}}function r(n,t){var r=e(n,t),c=o();return function(n){!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return r.fork(null,c(n))}}function c(n){var t=u(n),e=[];return Object.keys(t).reduce(function(n,o){return n["@"+o]=function(){(e[o]||(e[o]=t[o]())).note()},n},{})}function u(n){return{kick:function(){return new n.Kick({decay:.2,freq:80}).connect()},snare:function(){return new n.Snare({amp:.3,snappy:1.5}).connect()},hat:function(){return new n.Hat({amp:1.5}).connect()},conga:function(){return new n.Conga({amp:.25,freq:400}).connect()},tom:function(){return new n.Tom({amp:.25,freq:400}).connect()},pluck:function(){var t=new n.PolyKarplusStrong({freq:400,maxVoices:32,amp:.7}).connect(),e=t.note.bind(t);return t.note=function(){var n=t.freq,o=t.amp;t.damping=1- -6/Math.log(n/sampleRate),e(n,o)},t},bass:function(){return new n.MonoSynth({attack:44,decay:n.Time.beats(.25),filterMult:.25,octave2:0,octave3:0}).connect()}}}var i=1,a=function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.1;return function(t){var e=setInterval(function(){return t(n)},1e3*n);return function(){return clearInterval(e)}}},f=/^(@[^-]+)(-.*)$/,p={"@log":function(n){var t=n.stack.pop();console.log(n.time,t)},"@wait":function(n){var t=n.stack.pop();n.time+=t},"@call":function(n,t){var e=n.stack.pop();n.call(t,"@"+e)},"@defn":function(n,t){var e="@"+n.stack.pop(),o=n.stack.pop();t.lib[e]=function(n){return n.load(o)}},"@let":function(n){var t=n.stack.pop(),e=n.stack.pop();n.context||(n.context={}),n.context[t]=e},"@get":function(n){for(var t=n.stack.pop(),e=n;void 0===e.context[t]&&e.parent;)e=e.parent;n.stack.push(e.context[t])},"@set":function(n){for(var t=n.stack.pop(),e=n.stack.pop(),o=n;void 0===o.context[t]&&o.parent;)o=o.parent;o.context[t]=e}},s=function(n,t){return(n%t+t)%t},l=function(n){return function(t){t.stack.push(n(t.stack.pop()))}},d=function(n){return function(t){t.stack.push(n(t.stack.pop(),t.stack.pop()))}},v={"@add":d(function(n,t){return t+n}),"@sub":d(function(n,t){return t-n}),"@mul":d(function(n,t){return t*n}),"@div":d(function(n,t){return 0===n?0:t/n}),"@wrap":d(function(n,t){return 0===n?0:s(t,n)}),"@mod":d(function(n,t){return 0===n?0:t%n}),"@neg":l(function(n){return-n}),"@cond":function(n){var t=n.stack.pop(),e=n.stack.pop(),o=n.stack.pop();t?n.load(o):n.load(e)},"@>":d(function(n,t){return t>n}),"@>=":d(function(n,t){return t>=n}),"@<":d(function(n,t){return t<n}),"@<=":d(function(n,t){return t<=n}),"@==":d(function(n,t){return t===n}),"@!=":d(function(n,t){return t!==n}),"@not":l(function(n){return!n}),"@and":d(function(n,t){return t&&n}),"@or":d(function(n,t){return t||n})},h={"@id":function(n){var t=n.stack.pop();n.id=t},"@exit":function(n){n.operations.length=0},"@repeat":function(n){var t=n.stack.pop(),e=n.stack.pop();t>1&&n.load([e,t-1,"@repeat"]),n.load(e)},"@forever":function(n){var t=n.stack.pop();n.load([t,"@forever"]),n.load(t)},"@fork":function(n,t){if(t.schedule){var e=n.stack.pop();t.schedule.fork(n,e)}},"@spawn":function(n,t){if(t.schedule){var e=n.stack.pop();t.schedule.remove(e);var o=n.stack.pop();t.schedule.fork(n,[e,"@id",o,"@forever"])}},"@loop":function(n,t){if(t.schedule){var e=n.stack.pop();t.schedule.fork(n,[e,"@forever"])}},"@stop":function(n,t){if(t.schedule){var e=n.stack.pop();t.schedule.remove(e)}},"@pause":function(n){},"@resume":function(n){}},k=Object.assign({},p,v,h),m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n};n.initGibberish=function(n){!n&&void 0!==("undefined"==typeof window?"undefined":m(window))&&window.Gibberish&&(n=window.Gibberish),n.context||n.init();return r({Gibberish:n,lib:Object.assign({},k,c(n))},function(t){var e=1/n.context.sampleRate;n.sequencers.push({tick:function(){return t(e)}})})},Object.defineProperty(n,"__esModule",{value:!0})});
