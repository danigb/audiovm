!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(n.AudioVM={})}(this,function(n){"use strict";function t(n){var t={id:f++,time:0,context:{},stack:[],operations:[]};return Object.assign(t,n),t.exec=function(n){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3;t.time<e&&--o&&t.operations.length;){var r=t.operations.pop();"function"==typeof r?r(t,n):"string"==typeof r&&"@"===r[0]?t.call(n,r):t.stack.push(r)}if(!o)throw Error("[proc:"+t.id+" - Loop limit reached");return t},t.load=function(n){for(var e=n.length;e--;)t.operations.push(n[e]);return t},t.call=function(n,e){var o=n.lib[e];"function"==typeof o?o(t,n):console.warn(e+" is not a function.")},t}function e(){function n(n){for(var t=r.length-1;t>=0&&r[t].time<n.time;)t--;return r.splice(t+1,0,n),n}var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:p(),r=[];return n.time=0,n.env=Object.assign({schedule:n},e),n.fork=function(e,o){return n(t({parent:e,time:n.time}).load(o))},n.count=function(){return r.length},n.processes=function(){return r.slice()},n.find=function(n){return r.find(function(t){return t.id===n})},n.remove=function(n){for(var t=0;t<r.length;t++)if(r[t].id===n)return r.splice(t,1),!0;return!1},n.removeAll=function(){return r.length=0},o(function(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3,o=n.time+t,c=r.pop();c&&c.time<o&&e--;)c.exec(n.env,o),c.operations.length&&n(c),c=r.pop();c&&r.push(c),n.time=o}),n}function o(){return function n(t){var e=void 0;return t.reduce(function(t,o){return Array.isArray(o)?t.push(n(o)):(e=s.exec(o))?(t.push(e[2].slice(1)),t.push(e[1])):t.push(o),t},[])}}function r(n,t){var r=e(n,t),c=o();return function(n){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],e=c(n);return t&&(r.count()?e.unshift("@sync"):r.time=Math.floor(r.time+1)),r.fork(null,e)}}function c(n,t){if(1===arguments.length)return function(t){return c(n,t)};for(var e=t<0?-1:1,o=e*t,r=[],u=0;u<o;u++)r.push(n(e*u));return r}function u(n){var t=A.exec(n);if(!t)return NaN;var e=(t[1].toUpperCase().charCodeAt(0)+3)%7,o=t[2].replace(/x/g,"##"),r=+t[3]||-1,c="b"===o[0]?-1:1;return j[e]+c*o.length+12*r+12}function i(n){var t=a(n),e=[];return Object.keys(t).reduce(function(n,o){return n["@"+o]=function(){(e[o]||(e[o]=t[o]())).note()},n},{})}function a(n){return{kick:function(){return new n.Kick({decay:.2,freq:80}).connect()},snare:function(){return new n.Snare({amp:.3,snappy:1.5}).connect()},hat:function(){return new n.Hat({amp:1.5}).connect()},conga:function(){return new n.Conga({amp:.25,freq:400}).connect()},tom:function(){return new n.Tom({amp:.25,freq:400}).connect()},pluck:function(){var t=new n.PolyKarplusStrong({freq:400,maxVoices:32,amp:.7}).connect(),e=t.note.bind(t),o=n.sampleRate;return t.note=function(){var n=t.freq,r=t.amp;t.damping=1- -6/Math.log(n/o),e(n,r)},t},bass:function(){return new n.MonoSynth({attack:44,decay:n.Time.beats(.25),filterMult:.25,octave2:0,octave3:0}).connect()}}}var f=1,p=function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.1;return function(t){var e=setInterval(function(){return t(n)},1e3*n);return function(){return clearInterval(e)}}},s=/^(@[^-]+)(-.*)$/,l={"@log":function(n){var t=n.stack.pop();console.log(n.time,t)},"@wait":function(n){var t=n.stack.pop();n.time+=t},"@sync":function(n){Math.floor(n.time)+1-n.time<.99&&(n.time=Math.floor(n.time+1))},"@call":function(n,t){var e=n.stack.pop();n.call(t,"@"+e)},"@defn":function(n,t){var e="@"+n.stack.pop(),o=n.stack.pop();t.lib[e]=function(n){return n.load(o)}},"@let":function(n){var t=n.stack.pop(),e=n.stack.pop();n.context||(n.context={}),n.context[t]=e},"@get":function(n){for(var t=n.stack.pop(),e=n;void 0===e.context[t]&&e.parent;)e=e.parent;n.stack.push(e.context[t])},"@set":function(n){for(var t=n.stack.pop(),e=n.stack.pop(),o=n;void 0===o.context[t]&&o.parent;)o=o.parent;o.context[t]=e}},d=function(n,t){return(n%t+t)%t},v=function(n){return function(t){t.stack.push(n(t.stack.pop()))}},h=function(n){return function(t){t.stack.push(n(t.stack.pop(),t.stack.pop()))}},m={"@add":h(function(n,t){return t+n}),"@sub":h(function(n,t){return t-n}),"@mul":h(function(n,t){return t*n}),"@div":h(function(n,t){return 0===n?0:t/n}),"@wrap":h(function(n,t){return 0===n?0:d(t,n)}),"@mod":h(function(n,t){return 0===n?0:t%n}),"@neg":v(function(n){return-n}),"@cond":function(n){var t=n.stack.pop(),e=n.stack.pop(),o=n.stack.pop();t?n.load(o):n.load(e)},"@>":h(function(n,t){return t>n}),"@>=":h(function(n,t){return t>=n}),"@<":h(function(n,t){return t<n}),"@<=":h(function(n,t){return t<=n}),"@==":h(function(n,t){return t===n}),"@!=":h(function(n,t){return t!==n}),"@not":v(function(n){return!n}),"@and":h(function(n,t){return t&&n}),"@or":h(function(n,t){return t||n})},k={"@id":function(n){var t=n.stack.pop();n.id=t},"@exit":function(n){n.operations.length=0},"@repeat":function(n){var t=n.stack.pop(),e=n.stack.pop();t>1&&n.load([e,t-1,"@repeat"]),n.load(e)},"@forever":function(n){var t=n.stack.pop();n.load([t,"@forever"]),n.load(t)},"@fork":function(n,t){if(t.schedule){var e=n.stack.pop();t.schedule.fork(n,e)}},"@spawn":function(n,t){if(t.schedule){var e=n.stack.pop();t.schedule.remove(e);var o=n.stack.pop();t.schedule.fork(n,[e,"@id",o,"@forever"])}},"@loop":function(n,t){if(t.schedule){var e=n.stack.pop();t.schedule.fork(n,[e,"@forever"])}},"@stop:all":function(n,t){t.schedule&&t.schedule.removeAll()},"@stop":function(n,t){if(t.schedule){var e=n.stack.pop();t.schedule.remove(e)}},"@pause":function(n){},"@resume":function(n){}},g=Math.floor,b=function(n,t){return(n%t+t)%t},y=function(n){var t=u(n);return isNaN(t)?parseFloat(n):t},w=("C Db D Eb E F Gb G Ab A Bb B".split(" "),function(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:440;return Math.pow(2,(n-69)/12)*t}),x=function(n){return function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return function(e){var o=b(e,n.length),r=g(e/n.length);return t+n[o]+12*r}}},M={chromatic:function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return function(t){return n+t}},major:x([0,2,4,5,7,9,11]),minor:x([0,2,3,5,7,8,10])},A=/^([a-gA-G])(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*$/,j=[0,2,4,5,7,9,11],S={"@mtof":function(n){var t=y(n.stack.pop());n.stack.push(w(t))},"@scale":function(n){var t=n.stack.pop(),e=n.stack.pop(),o=y(n.stack.pop()),r=M[e]?c(M[e](o),t):[];n.stack.push(r)}},G=Object.assign({},l,m,k,S),q="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n};n.initGibberish=function(n){!n&&void 0!==("undefined"==typeof window?"undefined":q(window))&&window.Gibberish&&(n=window.Gibberish),n.context||n.init();return r({Gibberish:n,lib:Object.assign({},G,i(n))},function(t){var e=1/n.context.sampleRate;n.sequencers.push({tick:function(){return t(e)}})})},Object.defineProperty(n,"__esModule",{value:!0})});
