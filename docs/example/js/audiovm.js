!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(n.AudioVM={})}(this,function(n){"use strict";function t(n){var t={id:""+a++,time:0,context:{},stack:[],operations:[]};return Object.assign(t,n),t.exec=function(n){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3;t.time<e&&--r&&t.operations.length;){var o=t.operations.pop();"function"==typeof o?o(t,n):"string"==typeof o&&"@"===o[0]?t.call(n,o):t.stack.push(o)}if(!r)throw Error("[proc:"+t.id+" - Loop limit reached");return t},t.load=function(n){for(var e=n.length;e--;)t.operations.push(n[e]);return t},t.call=function(n,e){var r=n.lib[e];"function"==typeof r?r(t,n):console.warn(e+" is not a function.")},t}function e(){function n(n){for(var t=o.length-1;t>=0&&o[t].time<n.time;)t--;return o.splice(t+1,0,n),n}var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:f(),o=[];return n.time=0,n.env=Object.assign({schedule:n},e),n.fork=function(e,r){return n(t({parent:e,time:n.time}).load(r))},n.count=function(){return o.length},n.processes=function(){return o.slice()},n.find=function(n){return o.find(function(t){return t.id===n})},n.remove=function(n){for(var t=0;t<o.length;t++)if(o[t].id===n)return o.splice(t,1),!0;return!1},n.removeAll=function(){return o.length=0},r(function(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3,r=n.time+t,c=o.pop();c&&c.time<r&&e--;)c.exec(n.env,r),c.operations.length&&n(c),c=o.pop();c&&o.push(c),n.time=r}),n}function r(n,t,r){var o=e(n,t);return r||(r=function(n){return n}),{env:n,schedule:o,transpile:r,run:function(n){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],e=r(n);return t&&(o.count()?e.unshift("@sync"):o.time=Math.floor(o.time+1)),o.fork(null,e)},debug:function(){var t=n.lib,e=Object.keys(t);return e.forEach(function(n){var e=t[n];t[n]=function(t,r){var o=t.stack[t.stack.length-1],c=t.stack[t.stack.length-2];console.log("at",t.time,n,o,c),e(t,r)}}),e}}}function o(n,t){if(1===arguments.length)return function(t){return o(n,t)};for(var e=t<0?-1:1,r=e*t,c=[],u=0;u<r;u++)c.push(n(e*u));return c}function c(n){var t=R.exec(n);if(!t)return NaN;var e=(t[1].toUpperCase().charCodeAt(0)+3)%7,r=t[2].replace(/x/g,"##"),o=+t[3]||-1,c="b"===r[0]?-1:1;return T[e]+c*r.length+12*o+12}function u(n){var t=i(n),e=[],r=function(n){return e[n]||(e[n]=t[n]())};return Object.keys(t).reduce(function(n,t){return n["@"+t]=function(){r(t).note()},n["@"+t+":note"]=function(n){var e=r(t);e.freq=n.stack.pop(),e.note()},n["@"+t+":set"]=function(n){r(t)[n.stack.pop()]=n.stack.pop()},n},{})}function i(n){return{kick:function(){return new n.Kick({decay:.2,freq:80}).connect()},snare:function(){return new n.Snare({amp:.3,snappy:1.5}).connect()},hat:function(){return new n.Hat({amp:1.5}).connect()},conga:function(){return new n.Conga({amp:.25,freq:400}).connect()},tom:function(){return new n.Tom({amp:.25,freq:400}).connect()},pluck:function(){var t=new n.PolyKarplusStrong({freq:400,maxVoices:32,amp:.7}).connect(),e=t.note.bind(t),r=n.sampleRate;return t.note=function(){var n=t.freq,o=t.amp;t.damping=1- -6/Math.log(n/r),e(n,o)},t},bass:function(){return new n.MonoSynth({attack:44,decay:n.Time.beats(.25),filterMult:.25,octave2:0,octave3:0}).connect()}}}var a=1,f=function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.1;return function(t){var e=setInterval(function(){return t(n)},1e3*n);return function(){return clearInterval(e)}}},s=function(n){return function(t){return"string"==typeof t&&n.exec(t)}},p=/^##/,l=function(){return null};l.test=s(p);var v=/^@>>\s*$/,h=function(n,t,e,r,o){if(0!==e)throw Error("Forward operator must be the first of an array");o(r.slice(1).reverse()).forEach(function(t){return n.push(t)}),r.length=0};h.test=s(v);var d=/^#@>>\s*$/,k=function(n,t,e,r,o){o(t.slice(1).reverse()).forEach(function(t){return n.push(t)})};k.test=function(n){return!!Array.isArray(n)&&s(d)(n[0])};var m=/^(@[^-]+)(-.*)$/,g=/^[\d\.]+$/,y=function(n,t,e,r,o,c){var u=c[2].slice(1);n.push(g.test(u)?+u:u),n.push(c[1])};y.test=s(m);var b=function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return function t(e){return Array.isArray(e)?e.slice().reduce(function(e,r,o,c){for(var u=0;u<n.length;u++){var i=n[u].test(r);if(i)return n[u](e,r,o,c,t,i),e}return Array.isArray(r)?e.push(t(r)):e.push(r),e},[]):t([e])[0]}}([l,k,h,y]),w={"@eval":function(n){var t=n.stack.pop();n.load(t)},"@log":function(n){var t=n.stack.pop();console.log(n.time,t)},"@dup":function(n){var t=n.stack[n.stack.length-1];n.stack.push(t)},"@call":function(n,t){var e=n.stack.pop();n.call(t,"@"+e)},"@defn":function(n,t){var e="@"+n.stack.pop(),r=n.stack.pop();t.lib[e]=function(n){return n.load(r)}},"@let":function(n){var t=n.stack.pop(),e=n.stack.pop();n.context||(n.context={}),n.context[t]=e},"@get":function(n){for(var t=n.stack.pop(),e=n;void 0===e.context[t]&&e.parent;)e=e.parent;n.stack.push(e.context[t])},"@set":function(n){for(var t=n.stack.pop(),e=n.stack.pop(),r=n;void 0===r.context[t]&&r.parent;)r=r.parent;r.context[t]=e}},x=function(n,t){return(n%t+t)%t},A=function(n){return function(t){t.stack.push(n(t.stack.pop()))}},M=function(n){return function(t){t.stack.push(n(t.stack.pop(),t.stack.pop()))}},j={"@add":M(function(n,t){return t+n}),"@sub":M(function(n,t){return t-n}),"@mul":M(function(n,t){return t*n}),"@div":M(function(n,t){return 0===n?0:t/n}),"@wrap":M(function(n,t){return 0===n?0:x(t,n)}),"@mod":M(function(n,t){return 0===n?0:t%n}),"@neg":A(function(n){return-n}),"@cond":function(n){var t=n.stack.pop(),e=n.stack.pop(),r=n.stack.pop();t?n.load(r):n.load(e)},"@>":M(function(n,t){return t>n}),"@>=":M(function(n,t){return t>=n}),"@<":M(function(n,t){return t<n}),"@<=":M(function(n,t){return t<=n}),"@==":M(function(n,t){return t===n}),"@!=":M(function(n,t){return t!==n}),"@not":A(function(n){return!n}),"@and":M(function(n,t){return t&&n}),"@or":M(function(n,t){return t||n})},S={"@wait":function(n){var t=n.stack.pop();n.time+=t},"@sync":function(n){Math.floor(n.time)+1-n.time<.99&&(n.time=Math.floor(n.time+1))},"@id":function(n){var t=n.stack.pop();n.id=t},"@exit":function(n){n.operations.length=0},"@repeat":function(n){var t=n.stack.pop(),e=n.stack.pop();t>1&&n.load([e,t-1,"@repeat"]),n.load(e)},"@forever":function(n){var t=n.stack.pop();n.load([t,"@forever"]),n.load(t)},"@fork":function(n,t){if(t.schedule){var e=n.stack.pop();t.schedule.fork(n,e)}},"@spawn":function(n,t){if(t.schedule){var e=n.stack.pop();t.schedule.remove(e);var r=n.stack.pop();t.schedule.fork(n,[e,"@id",r,"@forever"])}},"@loop":function(n,t){if(t.schedule){var e=n.stack.pop();t.schedule.fork(n,[e,"@forever"])}},"@stop:all":function(n,t){t.schedule&&t.schedule.removeAll()},"@stop":function(n,t){var e=n.stack.pop(),r=t.schedule.remove(e);console.log("stop",e,r)},"@pause":function(n){},"@resume":function(n){}},q="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n},E=function(n){if(Array.isArray(n)){for(var t=0,e=Array(n.length);t<n.length;t++)e[t]=n[t];return e}return Array.from(n)},G={"@each":function(n){var t=n.stack.pop(),e=n.stack[n.stack.length-1];if(e.length){var r=e.shift();n.load([r].concat(E(t),[t,"@each"]))}}},O=Math.floor,$=Math.random,C=function(n){return O($()*n)},N={"@rand":function(n){n.stack.push($())},"@pick":function(n){var t=n.stack[n.stack.length-1];n.stack.push(t[C(t.length)])}},F=Math.floor,B=function(n,t){return(n%t+t)%t},D=function(n){var t=c(n);return isNaN(t)?parseFloat(n):t},I=("C Db D Eb E F Gb G Ab A Bb B".split(" "),function(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:440;return Math.pow(2,(n-69)/12)*t}),K=function(n){return function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return function(e){var r=B(e,n.length),o=F(e/n.length);return t+n[r]+12*o}}},P={chromatic:function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return function(t){return n+t}},major:K([0,2,4,5,7,9,11]),minor:K([0,2,3,5,7,8,10])},R=/^([a-gA-G])(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*$/,T=[0,2,4,5,7,9,11],V={"@mtof":function(n){var t=D(n.stack.pop());n.stack.push(I(t))},"@scale":function(n){var t=n.stack.pop(),e=D(n.stack.pop()),r=n.stack.pop(),c=P[r]?o(P[r](e),t):[];n.stack.push(c)}},_=Object.assign({},w,j,S,G,N,V);n.initGibberish=function(n){!n&&void 0!==("undefined"==typeof window?"undefined":q(window))&&window.Gibberish&&(n=window.Gibberish),n.context||n.init();return r({Gibberish:n,lib:Object.assign({},_,u(n))},function(t){var e=1/n.context.sampleRate;n.sequencers.push({tick:function(){return t(e)}})},b)},Object.defineProperty(n,"__esModule",{value:!0})});
