<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: gibberish.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: gibberish.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import VM from "./vm";
import macros from "./macros";
import lib from "./library";

/**
 * Create a `run` function using the Gibberish library
 * 
 * @function
 * @name initGibberish
 * @param [Gibberish] Gibberish
 * @return {function} a function to run VM programs
 * 
 * @example
 * const run = AudioVM.initGibberish();
 * run([['@pluck', 1, '@wait'], '@loop']);
 * @example
 * // es6 modules
 * import { initGibberish } from 'audiovm'
 * const run = initGibberish();
 */
export default function init(Gibberish) {
  if (!Gibberish &amp;&amp; typeof window !== undefined &amp;&amp; window.Gibberish) {
    Gibberish = window.Gibberish;
  }
  if (!Gibberish.context) {
    Gibberish.init();
  }

  const env = {
    Gibberish,
    lib: Object.assign({}, lib, createLibrary(Gibberish))
  };

  const clock = resume => {
    const bpm2bpa = 1 / Gibberish.context.sampleRate;
    Gibberish.sequencers.push({
      tick: () => resume(bpm2bpa)
    });
  };

  return VM(env, clock, macros);
}

function createLibrary(Gibberish) {
  const create = factories(Gibberish);
  const names = Object.keys(create);
  const cache = [];
  const get = name => cache[name] || (cache[name] = create[name]());

  return names.reduce((lib, name) => {
    lib["@" + name] = () => {
      const inst = get(name);
      inst.note();
    };
    lib["@" + name + ":note"] = proc => {
      const inst = get(name);
      inst.freq = proc.stack.pop();
      inst.note();
    };
    lib["@" + name + ":set"] = proc => {
      const inst = get(name);
      const key = proc.stack.pop();
      inst[key] = proc.stack.pop();
    };
    return lib;
  }, {});
}

function factories(Gibberish) {
  return {
    kick: () => new Gibberish.Kick({ decay: 0.2, freq: 80 }).connect(),
    snare: () => new Gibberish.Snare({ amp: 0.3, snappy: 1.5 }).connect(),
    hat: () => new Gibberish.Hat({ amp: 1.5 }).connect(),
    conga: () => new Gibberish.Conga({ amp: 0.25, freq: 400 }).connect(),
    tom: () => new Gibberish.Tom({ amp: 0.25, freq: 400 }).connect(),
    pluck: () => {
      const pluck = new Gibberish.PolyKarplusStrong({
        freq: 400,
        maxVoices: 32,
        amp: 0.7
      }).connect();
      const _note = pluck.note.bind(pluck);
      const sampleRate = Gibberish.sampleRate;
      pluck.note = () => {
        const freq = pluck.freq;
        const amp = pluck.amp;
        pluck.damping = 1 - -6 / Math.log(freq / sampleRate);
        _note(freq, amp);
      };
      return pluck;
    },
    bass: () =>
      new Gibberish.MonoSynth({
        attack: 44,
        decay: Gibberish.Time.beats(0.25),
        filterMult: 0.25,
        octave2: 0,
        octave3: 0
      }).connect()
  };
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-alu.html">alu</a></li><li><a href="module-memory.html">memory</a></li><li><a href="module-music.html">music</a></li><li><a href="module-process.html">process</a></li><li><a href="module-random.html">random</a></li><li><a href="module-sequence.html">sequence</a></li></ul><h3>Global</h3><ul><li><a href="global.html#initGibberish">initGibberish</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Tue Aug 22 2017 22:46:06 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
